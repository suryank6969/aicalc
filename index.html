<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Scientific Calculator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Math.js for complex equation evaluation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.1/math.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
            color: #c9d1d9;
        }
        #calculator-grid {
            /* Now an 7-row, 4-column grid with a slight gap */
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem; 
        }
        .calc-btn {
            @apply p-4 m-0 rounded-xl text-xl font-semibold transition duration-150 ease-in-out shadow-lg;
        }
        .num-btn {
            @apply bg-gray-700 hover:bg-gray-600;
        }
        .op-btn {
            @apply bg-orange-600 text-white hover:bg-orange-500;
        }
        .func-btn {
            @apply bg-gray-600 text-cyan-300 hover:bg-gray-500;
        }
        .greek-btn {
            @apply text-base bg-gray-800 hover:bg-gray-700;
        }
        .chat-message {
            @apply p-3 my-2 rounded-xl max-w-[85%] text-sm;
        }
        .user-message {
            @apply bg-blue-600 text-white ml-auto rounded-br-none;
        }
        .ai-message {
            @apply bg-gray-700 text-white mr-auto rounded-tl-none;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Main Application Container -->
    <div class="flex flex-col lg:flex-row bg-gray-900 rounded-2xl shadow-2xl overflow-hidden w-full max-w-6xl h-[90vh]">

        <!-- Left Panel: Calculator Interface - NOW WITH SCROLLING -->
        <div class="w-full lg:w-3/5 p-4 md:p-8 flex flex-col overflow-y-auto">
            <h1 class="text-3xl font-bold mb-4 text-center text-white">Scientific Calculator</h1>
            
            <!-- Display Area -->
            <div class="mb-4 bg-gray-800 p-6 rounded-xl shadow-inner flex flex-col justify-end h-32">
                <div id="history" class="text-gray-400 text-sm overflow-hidden whitespace-nowrap text-right h-6"></div>
                <div id="display" class="text-white text-4xl font-light overflow-x-auto whitespace-nowrap text-right">0</div>
            </div>

            <!-- CALCULATOR BUTTON GRID (MOVED TO THE TOP FOR VISIBILITY) -->
            <div id="calculator-grid" class="grid grid-cols-4 gap-2 mb-4">
                <!-- Row 1: Trig / Log -->
                <button class="calc-btn func-btn" onclick="insertText('sin(')">sin</button>
                <button class="calc-btn func-btn" onclick="insertText('cos(')">cos</button>
                <button class="calc-btn func-btn" onclick="insertText('tan(')">tan</button>
                <button class="calc-btn func-btn" onclick="insertText('log(')">log</button>

                <!-- Row 2: Inverse Trig / Factorial -->
                <button class="calc-btn func-btn" onclick="insertText('asin(')">asin</button>
                <button class="calc-btn func-btn" onclick="insertText('acos(')">acos</button>
                <button class="calc-btn func-btn" onclick="insertText('atan(')">atan</button>
                <button class="calc-btn func-btn" onclick="insertText('!')">!</button> 

                <!-- Row 3: Utility / Powers / Operator -->
                <button class="calc-btn func-btn" onclick="insertText('sqrt(')">√</button>
                <button class="calc-btn func-btn" onclick="insertText('^2')">x²</button>
                <button class="calc-btn func-btn" onclick="insertText('^')">^</button>
                <button class="calc-btn op-btn" onclick="insertText('/')">/</button>

                <!-- Row 4: 7, 8, 9, * -->
                <button class="calc-btn num-btn" onclick="insertText('7')">7</button>
                <button class="calc-btn num-btn" onclick="insertText('8')">8</button>
                <button class="calc-btn num-btn" onclick="insertText('9')">9</button>
                <button class="calc-btn op-btn" onclick="insertText('*')">*</button>

                <!-- Row 5: 4, 5, 6, - -->
                <button class="calc-btn num-btn" onclick="insertText('4')">4</button>
                <button class="calc-btn num-btn" onclick="insertText('5')">5</button>
                <button class="calc-btn num-btn" onclick="insertText('6')">6</button>
                <button class="calc-btn op-btn" onclick="insertText('-')">-</button>

                <!-- Row 6: 1, 2, 3, + -->
                <button class="calc-btn num-btn" onclick="insertText('1')">1</button>
                <button class="calc-btn num-btn" onclick="insertText('2')">2</button>
                <button class="calc-btn num-btn" onclick="insertText('3')">3</button>
                <button class="calc-btn op-btn" onclick="insertText('+')">+</button>

                <!-- Row 7: Constants, 0, . -->
                <button class="calc-btn func-btn" onclick="insertText('e')">e</button>
                <button class="calc-btn func-btn" onclick="insertText('gamma')">γ</button>
                <button class="calc-btn num-btn" onclick="insertText('0')">0</button>
                <button class="calc-btn num-btn" onclick="insertText('.')">.</button>
                
                <!-- Row 8: Clear/Backspace/Paren -->
                <button class="calc-btn func-btn" onclick="clearDisplay()">AC</button>
                <button class="calc-btn func-btn" onclick="backspace()">&larr;</button>
                <button class="calc-btn func-btn" onclick="insertText('(')">(</button>
                <button class="calc-btn func-btn" onclick="insertText(')')">)</button>

                <!-- Final Equal Button, spanning all columns -->
                <button class="calc-btn bg-cyan-700 text-white hover:bg-cyan-600 col-span-4" onclick="calculate()">=</button>
            </div>
            <!-- END CALCULATOR BUTTON GRID -->

            <!-- Greek Symbols Panel -->
            <div class="mb-4 p-3 bg-gray-800 rounded-xl">
                <div class="text-sm font-semibold mb-2 text-cyan-300">Greek Symbols (Use as Variables)</div>
                <div class="grid grid-cols-6 gap-1">
                    <!-- Common Greek Symbols for Physics/Math -->
                    <button class="calc-btn greek-btn" onclick="insertSymbol('alpha')">α</button>
                    <button class="calc-btn greek-btn" onclick="insertSymbol('beta')">β</button>
                    <!-- Gamma (γ) is now available for insertion -->
                    <button class="calc-btn greek-btn" onclick="insertSymbol('gamma')">γ</button> 
                    <button class="calc-btn greek-btn" onclick="insertSymbol('delta')">Δ</button>
                    <button class="calc-btn greek-btn" onclick="insertSymbol('lambda')">λ</button>
                    <button class="calc-btn greek-btn" onclick="insertSymbol('pi')">π</button>
                    <button class="calc-btn greek-btn" onclick="insertSymbol('mu')">μ</button>
                    <button class="calc-btn greek-btn" onclick="insertSymbol('sigma')">Σ</button>
                    <button class="calc-btn greek-btn" onclick="insertSymbol('tau')">τ</button>
                    <button class="calc-btn greek-btn" onclick="insertSymbol('theta')">θ</button>
                    <button class="calc-btn greek-btn" onclick="insertSymbol('phi')">φ</button>
                    <button class="calc-btn greek-btn" onclick="insertSymbol('omega')">Ω</button>
                </div>
            </div>

            <!-- Formula Finder Feature (LLM Feature 1) -->
            <div class="mb-4 p-3 bg-gray-800 rounded-xl">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-sm font-semibold text-pink-300 flex items-center">
                        <span class="mr-2 text-lg">✨</span> Formula Finder
                    </div>
                    <button id="find-formula-btn" class="text-xs bg-pink-600 px-3 py-1 rounded-lg hover:bg-pink-500 transition duration-150" onclick="findFormula()">
                        Search
                    </button>
                </div>
                <input type="text" id="formula-input" placeholder="e.g., kinetic energy, ohms law" class="w-full p-2 rounded-lg bg-gray-700 text-white text-sm focus:outline-none focus:ring-1 focus:ring-pink-500 mb-2">
                <div id="formula-result" class="min-h-[3rem] p-2 bg-gray-900 rounded-lg text-sm italic text-gray-400">
                    Results will appear here.
                </div>
                <div id="formula-loading-indicator" class="text-pink-400 text-sm mt-1 hidden text-center">Searching for formula...</div>
            </div>

            <!-- Constant Lookup Feature (LLM Feature 2) -->
            <div class="mb-4 p-3 bg-gray-800 rounded-xl">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-sm font-semibold text-orange-300 flex items-center">
                        <span class="mr-2 text-lg">✨</span> Constant Lookup
                    </div>
                    <button id="lookup-constant-btn" class="text-xs bg-orange-600 px-3 py-1 rounded-lg hover:bg-orange-500 transition duration-150" onclick="lookupConstant()">
                        Get Value
                    </button>
                </div>
                <input type="text" id="constant-input" placeholder="e.g., Planck's constant, electron charge" class="w-full p-2 rounded-lg bg-gray-700 text-white text-sm focus:outline-none focus:ring-1 focus:ring-orange-500 mb-2">
                <div id="constant-result" class="min-h-[3rem] p-2 bg-gray-900 rounded-lg text-sm italic text-gray-400">
                    Numerical value and units will appear here.
                </div>
                <div id="constant-loading-indicator" class="text-orange-400 text-sm mt-1 hidden text-center">Searching for constant...</div>
            </div>

        </div>

        <!-- Right Panel: AI Assistant Chat -->
        <div class="w-full lg:w-2/5 p-4 md:p-6 bg-gray-800 flex flex-col rounded-b-2xl lg:rounded-none lg:rounded-r-2xl">
            <h2 class="text-xl font-bold mb-4 text-center text-cyan-300">Surybot Assistant</h2>
            <div class="text-xs text-center text-gray-400 mb-2">Ask for hints, help with physics formulas, or step-by-step solutions!</div>
            
            <!-- Chat Messages Container -->
            <div id="chat-window" class="flex-grow overflow-y-auto p-2 space-y-3 bg-gray-900 rounded-xl mb-4">
                <div class="chat-message ai-message">
                    Hello! I'm Surybot, your AI Tutor. I can help you solve equations, provide physics constants, explain formulas, or guide you through a calculation. How can I assist you today?
                </div>
            </div>

            <!-- Chat Input -->
            <div class="flex items-center">
                <input type="text" id="chat-input" placeholder="Type your question or problem..." class="flex-grow p-3 rounded-l-xl bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                <button id="send-btn" onclick="sendMessage()" class="p-3 bg-cyan-600 text-white rounded-r-xl hover:bg-cyan-500 transition duration-150">
                    Send
                </button>
            </div>
            <div id="loading-indicator" class="text-cyan-400 text-sm mt-2 hidden text-center">Thinking...</div>
        </div>
    </div>

    <script type="module">
        // =======================================================================
        // *** ACTION REQUIRED: INSERT YOUR GEMINI API KEY HERE ***
        //
        // NOTE: This key must be a valid, unrestricted key for Netlify deployment!
        // If left empty, it works only in the Canvas Preview environment.
        // -----------------------------------------------------------------------
        const GEMINI_API_KEY = ""; 
        // -----------------------------------------------------------------------
        //
        // =======================================================================

        // Global Constants and State
        const displayElement = document.getElementById('display');
        const historyElement = document.getElementById('history');
        const chatWindow = document.getElementById('chat-window');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        // Elements for Formula Finder
        const formulaInput = document.getElementById('formula-input');
        const formulaResult = document.getElementById('formula-result');
        const formulaLoadingIndicator = document.getElementById('formula-loading-indicator');
        const findFormulaBtn = document.getElementById('find-formula-btn');

        // Elements for Constant Lookup
        const constantInput = document.getElementById('constant-input');
        const constantResult = document.getElementById('constant-result');
        const constantLoadingIndicator = document.getElementById('constant-loading-indicator');
        const lookupConstantBtn = document.getElementById('lookup-constant-btn');

        let currentExpression = '0';
        const greekSymbolMap = {
            'alpha': 'α', 'beta': 'β', 'gamma': 'γ', 'delta': 'Δ',
            'lambda': 'λ', 'pi': 'π', 'mu': 'μ', 'sigma': 'Σ',
            'tau': 'τ', 'theta': 'θ', 'phi': 'φ', 'omega': 'Ω'
        };
        
        // Base API URL builder function
        function getApiUrl() {
            // Check for key validity if running outside of the special Canvas environment
            if (GEMINI_API_KEY === "" && (typeof __app_id === 'undefined' || typeof __initial_auth_token === 'undefined')) {
                // This means the user is running externally (like Netlify) and the key is missing.
                console.error("API Key is missing. Please update the GEMINI_API_KEY variable with your valid key for external hosting.");
                return null;
            }
            return `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
        }


        // --- Calculator Functions ---

        /** Updates the calculator display with the current expression. */
        const updateDisplay = () => {
            let displayString = currentExpression;
            for (const key in greekSymbolMap) {
                displayString = displayString.replace(new RegExp(key, 'g'), greekSymbolMap[key]);
            }

            displayElement.textContent = displayString.replace(/\s/g, ''); 
            if (currentExpression === '') {
                displayElement.textContent = '0';
            }
        };

        /** Inserts text into the current expression, handling the initial '0' state. */
        window.insertText = (text) => {
            if (currentExpression === '0' && text !== '.' && !isNaN(parseInt(text))) {
                currentExpression = text;
            } else if (currentExpression === '0' && text === '.') {
                currentExpression += text;
            } else if (currentExpression === '0' && isNaN(parseInt(text)) && text !== '.') {
                currentExpression = text;
            } else {
                currentExpression += text;
            }
            updateDisplay();
        };

        /** Handles inserting Greek symbols as named variables (e.g., 'alpha'). */
        window.insertSymbol = (symbolKey) => {
            if (currentExpression === '0') currentExpression = '';
            currentExpression += symbolKey;
            updateDisplay();
        };

        /** Clears the entire display and history. */
        window.clearDisplay = () => {
            currentExpression = '0';
            historyElement.textContent = '';
            updateDisplay();
        };

        /** Deletes the last character from the current expression. */
        window.backspace = () => {
            let isGreek = false;
            for (const key in greekSymbolMap) {
                // Check if the end of the expression is a full Greek key name (e.g., 'alpha')
                if (currentExpression.endsWith(key)) {
                    currentExpression = currentExpression.slice(0, -key.length);
                    isGreek = true;
                    break;
                }
            }
            if (!isGreek) {
                // Regular character deletion
                currentExpression = currentExpression.slice(0, -1);
            }
            
            if (currentExpression.length === 0) {
                currentExpression = '0';
            }
            updateDisplay();
        };

        /** Evaluates the current expression using math.js. */
        window.calculate = () => {
            try {
                const expressionToEvaluate = currentExpression;
                
                // Define constants used in physics/math, including the actual Math.E
                const scope = {
                    pi: Math.PI, 
                    c: 299792458, // speed of light (approximate value for demo)
                    g: 9.81, // acceleration due to gravity (approximate value for demo)
                    e: Math.E, // Euler's number (e)
                    gamma: 0.5772156649, // Euler-Mascheroni Constant (added numerical constant)
                    mu: 1.25663706e-6, // Permeability of free space (mu naught) (approximate value for demo)
                    lambda: 500e-9, // Example value for lambda (500 nm) (approximate value for demo)
                };

                const historyText = displayElement.textContent;
                const result = math.evaluate(expressionToEvaluate, scope);
                const formattedResult = math.format(result, { precision: 10, lowerExp: -9, upperExp: 15 });

                historyElement.textContent = historyText + ' =';
                currentExpression = String(formattedResult);
                updateDisplay();

            } catch (error) {
                historyElement.textContent = 'Error';
                currentExpression = '0';
                updateDisplay();
                console.error('Calculation Error:', error);
            }
        };

        // --- Formula Finder Functions (LLM Feature 1) ---

        /** Inserts the extracted formula placeholder into the calculator display. */
        window.copyFormulaToDisplay = (fullText) => {
            // Find the formula part. Assuming it's the first line before the "Where:"
            let formulaPart = fullText.split('Where:')[0].trim(); 
            
            // Try to extract only the right side of an equation (e.g., gets 'm*c^2' from 'E = m*c^2')
            let mathExpression = formulaPart.includes('=') ? formulaPart.split('=')[1].trim() : formulaPart;
            
            // Cleanup: remove spaces, remove common markdown/LaTeX notation if any got through.
            mathExpression = mathExpression.replace(/ \cdot /g, '*').replace(/ /g, '').replace(/[\r\n$]+/g, '');
            
            currentExpression = mathExpression.trim();
            updateDisplay();
            formulaResult.innerHTML = "<span class='text-green-400'>Formula inserted! Now replace the variable names with your numerical values.</span>";
        };


        /** Handles the Formula Finder search request. */
        window.findFormula = async () => {
            const concept = formulaInput.value.trim();
            if (concept === '') {
                formulaResult.innerHTML = "<span class='text-red-400'>Please enter a concept (e.g., 'momentum').</span>";
                return;
            }

            const apiUrl = getApiUrl();
            if (!apiUrl) {
                formulaResult.innerHTML = "<span class='text-red-400'>API Key Error: Please insert your Gemini API key in the script, especially for external hosting like Netlify.</span>";
                return;
            }

            formulaResult.innerHTML = "";
            findFormulaBtn.disabled = true;
            formulaLoadingIndicator.classList.remove('hidden');

            // *** UPDATED PROMPT: More robust and lenient to input errors ***
            const systemPrompt = `You are a Formula Extraction Specialist known for your robust ability to find formulas even with slight spelling or formatting errors (e.g., 'ohms law' or 'kinetic energy'). When given a concept, your SOLE job is to return the corresponding formula, followed by a brief definition of each variable. DO NOT include greetings, conversational filler, or step-by-step instructions. Present the formula on the first line using only **simple, linear plain text and math symbols**, suitable for direct calculator input. Use '/' for fractions and '^' for exponents. Use '*' for explicit multiplication. Use the phrase 'Where:' before defining variables.`;
            const userQuery = `Provide the formula for: ${concept}.`;

            const maxRetries = 3;
            let formulaText = "";
            let apiError = false;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: userQuery }] }],
                            tools: [{ "google_search": {} }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                        })
                    });

                    if (!response.ok) {
                        if (response.status === 400 || response.status === 401) {
                            console.error(`Gemini API Error (Status ${response.status}): Check API key or request payload.`);
                            apiError = true;
                            formulaText = "API Key/Network Error: Please check your console for details, ensure your key is correct, and the file is running on a local server (http://localhost:8000).";
                            break; 
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    formulaText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Formula not found or API returned an empty response.";
                    break;
                } catch (error) {
                    console.error(`Formula search attempt ${i + 1} failed (Retrying):`, error);
                    if (apiError) break; 
                    if (i === maxRetries - 1) {
                        formulaText = "Could not connect to the Formula Finder after several attempts. Please check your network or try again later.";
                    } else {
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            // Process result and add insertion button
            const processedText = formulaText.replace(/\n/g, '<br>');

            if (apiError || formulaText.includes("Could not connect")) {
                formulaResult.innerHTML = `<span class='text-red-400'>${processedText}</span>`;
            } else if (formulaText.includes("Formula not found")) {
                formulaResult.innerHTML = `<span class='text-yellow-400'>${processedText}</span>`;
            } else {
                // Pass the raw text to copyFormulaToDisplay
                formulaResult.innerHTML = `
                    <div class="text-sm text-white mb-2">${processedText}</div>
                    <button class="text-xs bg-green-600 px-3 py-1 rounded-lg hover:bg-green-500 transition duration-150 mt-1" 
                            onclick="copyFormulaToDisplay(\`${formulaText.replace(/`/g, '\\`')}\`)">
                        Insert Formula Placeholder
                    </button>
                `;
            }

            // Re-enable and hide loading
            findFormulaBtn.disabled = false;
            formulaLoadingIndicator.classList.add('hidden');
        };

        // --- Constant Lookup Functions (LLM Feature 2) ---

        /** Inserts the numerical value of the constant into the calculator display. */
        window.insertConstantValue = (value) => {
            // Strip any scientific notation formatting before inserting
            const cleanValue = value.replace(/ /g, '');

            if (currentExpression === '0') currentExpression = '';
            currentExpression += cleanValue;
            updateDisplay();
            constantResult.innerHTML = "<span class='text-green-400'>Value inserted into calculator.</span>";
        };

        /** Handles the Constant Lookup request. */
        window.lookupConstant = async () => {
            const constantName = constantInput.value.trim();
            if (constantName === '') {
                constantResult.innerHTML = "<span class='text-red-400'>Please enter a constant name (e.g., 'electron mass').</span>";
                return;
            }

            const apiUrl = getApiUrl();
            if (!apiUrl) {
                constantResult.innerHTML = "<span class='text-red-400'>API Key Error: Please insert your Gemini API key in the script, especially for external hosting like Netlify.</span>";
                return;
            }

            constantResult.innerHTML = "";
            lookupConstantBtn.disabled = true;
            constantLoadingIndicator.classList.remove('hidden');

            const systemPrompt = `You are a Numerical Constant Extractor. When given a physics or math constant (like 'Planck's constant' or 'speed of light'), your SOLE job is to return the precise numerical value, the standard symbol, and the standard SI units in a strict JSON format. DO NOT include conversational filler or definitions.`;
            const userQuery = `Find the value for: ${constantName}.`;

            const maxRetries = 3;
            let constantData = null;
            let apiError = false;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "value": { "type": "STRING", "description": "The precise numerical value, including scientific notation if needed, e.g., '6.62607015e-34'" },
                            "symbol": { "type": "STRING", "description": "The standard symbol, e.g., 'h'" },
                            "units": { "type": "STRING", "description": "The SI units, e.g., 'J⋅s'" }
                        },
                        required: ["value", "symbol", "units"]
                    }
                }
            };

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 400 || response.status === 401) {
                            apiError = true;
                            throw new Error("API Key/Network Error: Please check your key or network connection.");
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (jsonText) {
                        constantData = JSON.parse(jsonText);
                        break;
                    }
                } catch (error) {
                    console.error(`Constant lookup attempt ${i + 1} failed (Retrying):`, error);
                    if (apiError) break;
                    if (i === maxRetries - 1) {
                        constantResult.innerHTML = `<span class='text-red-400'>Failed to connect to the Constant Finder. Please try again.</span>`;
                        break;
                    } else {
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            if (apiError) {
                 constantResult.innerHTML = `<span class='text-red-400'>${new Error("API Key/Network Error: Please check your console for details, ensure your key is correct, and the file is running on a local server (http://localhost:8000).").message}</span>`;
            } else if (constantData && constantData.value) {
                const { value, symbol, units } = constantData;
                
                // Format the result display
                constantResult.innerHTML = `
                    <div class="text-sm text-white">
                        <span class="font-bold text-orange-300">${symbol}</span> = ${value} ${units}
                    </div>
                    <button class="text-xs bg-green-600 px-3 py-1 rounded-lg hover:bg-green-500 transition duration-150 mt-2" 
                            onclick="insertConstantValue('${value}')">
                        Insert Value (${symbol})
                    </button>
                `;
            } else {
                constantResult.innerHTML = `<span class='text-yellow-400'>Could not find a precise numerical value for "${constantName}". Try a more specific name.</span>`;
            }

            // Re-enable and hide loading
            lookupConstantBtn.disabled = false;
            constantLoadingIndicator.classList.add('hidden');
        };

        // --- Chat Assistant Functions (LLM Feature 3) ---
        
        // This is a simple in-memory history for a single session
        let chatHistory = []; 

        /** Creates and appends a message bubble to the chat window. */
        const appendMessage = (text, sender) => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender === 'user' ? 'user-message' : 'ai-message'}`;
            
            // Convert any math in $...$ format into displayable LaTeX-style format using a simple regex replace.
            let formattedText = text.replace(/\$(.*?)\$/g, (match, p1) => {
                // Apply inline styling to make it look distinct
                return `<span style="font-family: monospace; background-color: rgba(0,0,0,0.2); padding: 1px 3px; border-radius: 4px;">${p1}</span>`;
            });
            
            messageDiv.innerHTML = formattedText.replace(/\n/g, '<br>');
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight; // Auto-scroll to latest message
        };

        /** Sends the user message to the Gemini API. */
        window.sendMessage = async () => {
            const userText = chatInput.value.trim();
            if (userText === '') return;

            // 1. Display user message and clear input
            appendMessage(userText, 'user');
            chatInput.value = '';
            
            // 2. Add user message to history
            chatHistory.push({ role: 'user', parts: [{ text: userText }] });

            // 3. Show loading indicator and disable input/button
            loadingIndicator.classList.remove('hidden');
            chatInput.disabled = true;
            sendBtn.disabled = true;

            const apiUrl = getApiUrl();
            if (!apiUrl) {
                appendMessage("API Key Error: Please insert your Gemini API key in the script to use the Surybot Assistant (especially for external hosting like Netlify).", 'ai');
                loadingIndicator.classList.add('hidden');
                chatInput.disabled = false;
                sendBtn.disabled = false;
                return;
            }

            // *** UPDATED PROMPT: Highly supportive, friendly, and enthusiastic tone ***
            const systemPrompt = `You are Surybot, a highly supportive, friendly, and enthusiastic AI Scientific Tutor. Always maintain a conversational and encouraging tone. Your main goal is to help the user with math and physics problems, explain formulas simply, and provide clear, step-by-step guidance. When writing formulas, always use simple linear notation (e.g., use '/' for fractions like 1/f) over complex LaTeX (like \\frac) for better readability. Use the dollar sign $ for inline mathematical notation.`;

            const maxRetries = 3;
            let aiResponseText = "";
            let apiError = false;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: chatHistory, // Send the full history
                            tools: [{ "google_search": {} }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                        })
                    });

                    if (!response.ok) {
                         if (response.status === 400 || response.status === 401) {
                            apiError = true;
                            aiResponseText = "API Key/Network Error: Please check your console for details, ensure your key is correct, and the file is running on a local server (http://localhost:8000).";
                            break; 
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    aiResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text || "I apologize, I could not generate a response. The API returned an empty result.";
                    break;
                } catch (error) {
                    console.error(`Chat attempt ${i + 1} failed (Retrying):`, error);
                    if (apiError) break;
                    if (i === maxRetries - 1) {
                        aiResponseText = "I'm having trouble connecting right now. Please check your network and try again.";
                    } else {
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            // 4. Update UI
            appendMessage(aiResponseText, 'ai');
            
            // 5. Add AI response to history
            chatHistory.push({ role: 'model', parts: [{ text: aiResponseText }] });

            // 6. Restore input
            loadingIndicator.classList.add('hidden');
            chatInput.disabled = false;
            sendBtn.disabled = false;
            chatInput.focus();
        };

        // Event listener for the Send button on chat input (Enter key)
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendBtn.disabled) {
                window.sendMessage();
            }
        });

        // Initialize display on load
        window.onload = () => {
            updateDisplay();
        };

    </script>
</body>
</html>
